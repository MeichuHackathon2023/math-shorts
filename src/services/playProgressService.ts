import { prisma } from "@/utils/prisma";
import { PlayProgress } from "@prisma/client";

const playProgressService = {
    getPlayProgress: async ({
        userId,
        videoId,
    }: {
        userId: number;
        videoId: number;
    }) => {
        const playProgress = await prisma.playProgress.findUnique({
            where: {
                userId_videoId: {
                    userId: userId,
                    videoId: videoId,
                },
            },
        });
        return playProgress;
    },
    // getAllPlayProgress: async ({
    //     userId,
    // }: {
    //     userId: number;
    // }): PlayProgress[] => {
    //     return [];
    // },
    updateOrCreatePlayProgress: async ({
        userId,
        videoId,
        percentageElapsed,
    }: {
        userId: number;
        videoId: number;
        percentageElapsed: number;
    }) => {
        const playProgress = await prisma.playProgress.upsert({
            where: {
                userId_videoId: {
                    userId: userId,
                    videoId: videoId,
                },
            },
            update: { percentageElapsed: percentageElapsed },
            create: {
                userId: userId,
                videoId: videoId,
                percentageElapsed: percentageElapsed,
            },
        });
        return playProgress;
    },
    getPlayProgressDataForRec: async (userId: number) => {
        const userIds = [
            6
            ,
            7
            ,
            8
            ,
            9
            ,
            10
            ,
            11
            ,
            12
            ,
            13
            ,
            14
            ,
            15
            ,
            16
            ,
            17
            ];
        let userRecord = await prisma.playProgress.findMany({
            where: {
                userId: userId,
            }
        });
        userRecord = userRecord.sort((a, b) => b.updateTime.getTime() - a.updateTime.getTime()).slice(0,10);

        let records = [];
        for(let i = 0; i < userIds.length; i++) {
            let tmp = await prisma.playProgress.findMany({
                where: {
                    userId: userIds[i],
                }
            });
            records.push(tmp);
        }
        
        let newRecords = [];
        for (let i = 0; i < records.length; i++) {
            if (records[i][0].userId == userId) continue;
            records[i].sort((a, b) => b.updateTime.getTime() - a.updateTime.getTime());
            newRecords.push(records[i].slice(0, 10));
        }

        const idToTitle: { [id: number]: string } = {
            17: '109-13',
            18: '109-9',
            19: '109-8',
            20: '109-5',
            21: '109-4',
            22: '109-6',
            23: '109-7',
            24: '109-3',
            25: '109-2',
            26: '109-1',
            27: '109-20',
            28: '109-18',
            29: '102-10',
            30: '102-12',
            31: '102-8',
            32: '102-9',
            33: '102-13',
            34: '103-15',
            35: '103-7',
            36: '103-6',
            37: '103-14',
            38: '103-16',
            39: '103-4',
            40: '103-5',
            41: '103-17',
            42: '103-13',
            43: '103-1',
            44: '103-12',
            45: '103-10',
            46: '103-2',
            47: '103-3',
            48: '103-11',
            49: '103-20',
            50: '103-8',
            51: '103-9',
            52: '103-19',
            53: '103-18',
            54: '104-2',
            55: '104-3',
            56: '104-1',
            57: '104-4',
            58: '104-5',
            59: '104-7',
            60: '104-6',
            61: '104-20',
            62: '104-19',
            63: '104-18',
            64: '104-15',
            65: '104-14',
            66: '104-16',
            67: '104-17',
            68: '104-13',
            69: '104-12',
            70: '104-10',
            71: '104-11',
            72: '104-9',
            73: '105-17',
            74: '105-14',
            75: '105-15',
            76: '105-11',
            77: '105-10',
            78: '105-12',
            79: '105-13',
            80: '105-1',
            81: '105-2',
            82: '105-3',
            83: '105-7',
            84: '105-6',
            85: '105-4',
            86: '105-5',
            87: '105-8',
            88: '105-9',
            89: '105-20',
            90: '105-18',
            91: '105-19',
            92: '106-1',
            93: '106-2',
            94: '106-6',
            95: '106-7',
            96: '106-5',
            97: '106-4',
            98: '106-19',
            99: '106-18',
            100: '106-20',
            101: '106-10',
            102: '106-11',
            103: '106-13',
            104: '106-12',
            105: '106-16',
            106: '106-17',
            107: '106-15',
            108: '106-14',
            109: '106-9',
            110: '106-8',
            111: '107-13',
            112: '107-11',
            113: '107-10',
            114: '107-14',
            115: '107-15',
            116: '107-17',
            117: '107-16',
            118: '107-3',
            119: '107-2',
            120: '107-1',
            121: '107-5',
            122: '107-4',
            123: '107-6',
            124: '107-7',
            125: '107-9',
            126: '107-8',
            127: '107-18',
            128: '107-19',
            129: '107-20',
            130: '108-9',
            131: '108-8',
            132: '108-20',
            133: '108-19',
            134: '108-18',
            135: '108-14',
            136: '108-16',
            137: '108-17',
            138: '108-13',
            139: '108-12',
            140: '108-10',
            141: '108-11',
            142: '108-6',
            143: '108-7',
            144: '108-5',
            145: '108-4',
            146: '108-1',
            147: '108-3',
            148: '108-2',
            149: '112-18',
            150: '112-19',
            151: '112-20',
            152: '112-9',
            153: '112-8',
            154: '112-6',
            155: '112-7',
            156: '112-5',
            157: '112-4',
            158: '112-1',
            159: '112-3',
            160: '112-2',
            161: '112-12',
            162: '112-13',
            163: '112-11',
            164: '112-10',
            165: '112-14',
            166: '112-15',
            167: '112-17',
            168: '112-16',
            169: '111-8',
            170: '111-9',
            171: '111-15',
            172: '111-14',
            173: '111-16',
            174: '111-17',
            175: '111-13',
            176: '111-12',
            177: '111-10',
            178: '111-11',
            179: '111-20',
            180: '111-19',
            181: '111-18',
            182: '111-7',
            183: '111-6',
            184: '111-4',
            185: '111-5',
            186: '111-1',
            187: '111-2',
            188: '111-3',
            189: '110-20',
            190: '110-18',
            191: '110-19',
            192: '110-8',
            193: '110-9',
            194: '110-4',
            195: '110-5',
            196: '110-7',
            197: '110-2',
            198: '110-3',
            199: '110-1',
            200: '110-17',
            201: '110-16',
            202: '110-14',
            203: '110-15',
            204: '110-11',
            205: '110-10',
            206: '110-12',
            207: '110-13',
            208: '109-17',
            209: '109-16',
            210: '109-14',
            211: '109-15',
            212: '109-11',
            213: '109-10',
            214: '109-12',
        };
        const titleToIndex: { [title: string]: number } = {
            '102-10': 0,
            '102-12': 1,
            '102-13': 2,
            '102-8': 3,
            '102-9': 4,
            '103-1': 5,
            '103-10': 6,
            '103-11': 7,
            '103-12': 8,
            '103-13': 9,
            '103-14': 10,
            '103-15': 11,
            '103-16': 12,
            '103-17': 13,
            '103-2': 14,
            '103-3': 15,
            '103-4': 16,
            '103-5': 17,
            '103-6': 18,
            '103-7': 19,
            '103-8': 20,
            '103-9': 21,
            '104-1': 22,
            '104-10': 23,
            '104-11': 24,
            '104-12': 25,
            '104-13': 26,
            '104-14': 27,
            '104-15': 28,
            '104-16': 29,
            '104-17': 30,
            '104-18': 31,
            '104-19': 32,
            '104-2': 33,
            '104-20': 34,
            '104-3': 35,
            '104-4': 36,
            '104-5': 37,
            '104-6': 38,
            '104-7': 39,
            '104-9': 40,
            '105-1': 41,
            '105-10': 42,
            '105-11': 43,
            '105-12': 44,
            '105-13': 45,
            '105-14': 46,
            '105-15': 47,
            '105-16': 48,
            '105-17': 49,
            '105-18': 50,
            '105-19': 51,
            '105-2': 52,
            '105-20': 53,
            '105-3': 54,
            '105-4': 55,
            '105-5': 56,
            '105-6': 57,
            '105-7': 58,
            '105-8': 59,
            '105-9': 60,
            '106-1': 61,
            '106-10': 62,
            '106-11': 63,
            '106-12': 64,
            '106-13': 65,
            '106-14': 66,
            '106-15': 67,
            '106-16': 68,
            '106-17': 69,
            '106-18': 70,
            '106-19': 71,
            '106-2': 72,
            '106-20': 73,
            '106-3': 74,
            '106-4': 75,
            '106-5': 76,
            '106-6': 77,
            '106-7': 78,
            '106-8': 79,
            '106-9': 80,
            '107-1': 81,
            '107-10': 82,
            '107-11': 83,
            '107-12': 84,
            '107-13': 85,
            '107-14': 86,
            '107-15': 87,
            '107-16': 88,
            '107-17': 89,
            '107-18': 90,
            '107-19': 91,
            '107-2': 92,
            '107-20': 93,
            '107-3': 94,
            '107-4': 95,
            '107-5': 96,
            '107-6': 97,
            '107-7': 98,
            '107-8': 99,
            '107-9': 100,
            '108-1': 101,
            '108-10': 102,
            '108-11': 103,
            '108-12': 104,
            '108-13': 105,
            '108-14': 106,
            '108-15': 107,
            '108-16': 108,
            '108-17': 109,
            '108-18': 110,
            '108-19': 111,
            '108-2': 112,
            '108-20': 113,
            '108-3': 114,
            '108-4': 115,
            '108-5': 116,
            '108-6': 117,
            '108-7': 118,
            '108-8': 119,
            '108-9': 120,
            '109-1': 121,
            '109-10': 122,
            '109-11': 123,
            '109-12': 124,
            '109-13': 125,
            '109-14': 126,
            '109-15': 127,
            '109-16': 128,
            '109-17': 129,
            '109-18': 130,
            '109-19': 131,
            '109-2': 132,
            '109-20': 133,
            '109-3': 134,
            '109-4': 135,
            '109-5': 136,
            '109-6': 137,
            '109-7': 138,
            '109-8': 139,
            '109-9': 140,
            '110-1': 141,
            '110-10': 142,
            '110-11': 143,
            '110-12': 144,
            '110-13': 145,
            '110-14': 146,
            '110-15': 147,
            '110-16': 148,
            '110-17': 149,
            '110-18': 150,
            '110-19': 151,
            '110-2': 152,
            '110-20': 153,
            '110-3': 154,
            '110-4': 155,
            '110-5': 156,
            '110-7': 157,
            '110-8': 158,
            '110-9': 159,
            '111-1': 160,
            '111-10': 161,
            '111-11': 162,
            '111-12': 163,
            '111-13': 164,
            '111-14': 165,
            '111-15': 166,
            '111-16': 167,
            '111-17': 168,
            '111-18': 169,
            '111-19': 170,
            '111-2': 171,
            '111-20': 172,
            '111-3': 173,
            '111-4': 174,
            '111-5': 175,
            '111-6': 176,
            '111-7': 177,
            '111-8': 178,
            '111-9': 179,
            '112-1': 180,
            '112-10': 181,
            '112-11': 182,
            '112-12': 183,
            '112-13': 184,
            '112-14': 185,
            '112-15': 186,
            '112-16': 187,
            '112-17': 188,
            '112-18': 189,
            '112-19': 190,
            '112-2': 191,
            '112-20': 192,
            '112-3': 193,
            '112-4': 194,
            '112-5': 195,
            '112-6': 196,
            '112-7': 197,
            '112-8': 198,
            '112-9': 199
        }

        let result = [];

        let tmp = Array.from({ length: 250 }, () => 0);
        for (let i = 0; i < userRecord.length; i++) {
            tmp[titleToIndex[idToTitle[userRecord[i].videoId]]] = userRecord[i].percentageElapsed;
        }
        result.push(tmp);

        for (let i = 0; i < records.length; i++) {
            if (records[i][0].userId == userId) continue;
            tmp = Array.from({ length: 250 }, () => 0);
            for (let i = 0; i < records[i].length; i++) {
                tmp[titleToIndex[idToTitle[records[i][i].videoId]]] = records[i][i].percentageElapsed;
            }
            result.push(tmp);
        }

        return result;
    }
};

export default playProgressService;
